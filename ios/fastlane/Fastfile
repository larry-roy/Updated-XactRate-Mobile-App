# ios/fastlane/Fastfile

require 'dotenv'
Dotenv.load('./fastlane/.env')

default_platform(:ios)

platform :ios do
  desc "Build and upload a new beta version to TestFlight"
  lane :beta do

    #xcodes(version: "16")

    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
      is_key_content_base64: true
    )

    match(
      type: "appstore",
      readonly: is_ci,
      app_identifier: ENV["BUNDLE_IDENTIFIER"]
    )
    
    build_number = number_of_commits
    increment_build_number(
      build_number: build_number,
      xcodeproj: "XactRate.xcodeproj"
    )
    UI.message("Successfully set build number to #{build_number}")

    # --- THIS IS THE DEFINITIVE FIX ---
    # This block forces Xcode to use manual signing during the `archive` step itself.
    build_app(
      workspace: "XactRate.xcworkspace",
      scheme: "XactRate",
      export_method: "app-store",
      
      # Use `xcargs` to pass settings directly to the `xcodebuild archive` command
      xcargs: {
        "CODE_SIGN_STYLE" => "Manual",
        "CODE_SIGN_IDENTITY" => "Apple Distribution",
        "PROVISIONING_PROFILE_SPECIFIER" => "match AppStore #{ENV["BUNDLE_IDENTIFIER"]}",
        "build_system" => "new",
        "COMPILER_INDEX_STORE_ENABLE" => "NO"
      },

      # The `export_options` are still needed for the `export` step
      export_options: {
        method: "app-store",
        signingStyle: "manual",
        provisioningProfiles: {
          ENV["BUNDLE_IDENTIFIER"] => "match AppStore #{ENV["BUNDLE_IDENTIFIER"]}"
        }
      }
    )

    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )
    
    UI.success("ðŸš€ Successfully built and uploaded to TestFlight! ðŸš€")
  end
end